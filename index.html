<!DOCTYPE HTML>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Railforth Prototype</title>
  <script src="./build/main.js"></script>
</head>

<body>
  <script>
    const storage = window.localStorage;
    let program = "";
    if (storage) {
      program = storage.getItem("program") || `(
操作：
ドラッグ / スワイプ → 回転
Shift+ドラッグ / 二本指スワイプ → 移動
マウスホイール / ピンチ操作 → 拡大縮小

プラレール全加算器 flat ver.
これはプラレールで全加算器を実現するレイアウトの定義ファイルです。
2024/10/26 に OSC 2024 Tokyo/Fall にて展示します。

なお、ライセンスは MIT ライセンスで提供されます。
)

( ***** 入力Cの開始 ***** )
invert 

dts .
  ss .
ss
dts .
  s stop . ( 入力Cの開始地点 )
s stop
dts .
  ss .
ss
dts .
  ss .
ss
dts .
  ss h .
ss h

dtl . . dtl .
  save c=1-start
  save c=0-start

load c=0-start
  q j l owl2
    save c=0-after-oneway
  save c=0-uturn

load c=0-uturn
  rr j dr
    uturn .
  .

load c=1-start
  s l r at1
    save c0-out-0
  j .

load c=0-after-oneway
  bk s h q
  ac .
    save c=1-after-cross
  save c=0-after-cross

load c=1-after-cross
  j at1
    save c0-out-1
  .

load c=0-after-cross
  at
    save c=0-join
  . ( C0の入力をスキップする線路から繋がる )

load c=0-join
  j dl1
    .
  j at
    save c1-start
  . ( C0を読む方向の線路と繋がる )

load c1-start
  j at1
    save c1-out-0
  j ac1
      save c1=1-after-cross
    save c1=0-after-cross
  save c1-uturn

load c1-uturn
  j rr rr dr
    uturn .
  .

load c1=1-after-cross
 j fw at1
   save c1-out-1
 .

load c1=0-after-cross
  j ss dtl . . dtl . . dl1 .
  save c1-end

load c1-end
  q j h at
    save from-c1-to-read-b-before-cross
  .

load from-c1-to-read-b-before-cross
  ss ss s
  l r ll r l
  shr shr
  ss ss ss
  j
  dc1
     j . ( Sを書き込んだ後にやってくる )
    save read-b-after-cross
  save read-a1-after-cross-b

load read-b-after-cross
  q shl s h
  ll h j dr
    save b=1-start
  save b=0-start

( ***** Cからの出力 ****** )

load c0-out-0
  s q tl2 nip
  uturn
  ss ss q
  dl2 nip q

  ss ss ss ss 
  ol s q ol

  . ( save c-out-to-read-c )

load c0-out-1
  s j at2
    fw j q h .
  j .


load c1-out-1
  j at2
    nip
  fw ac3
      -rot
      bk .
    s .
  h tl1
    j .
  j uturn
  j dr
    nip
  ss h dl2
    nip
  dl2
    nip
  h l j l

  save s-out-to-read-a


( ***** 入力Bの開始 ***** )

load b=1-start
  q h s ss
  ol ol at1
    save b0-out-0
  j ac1
      save b=1-after-cross
    save b=0-after-cross
  .

load b=0-start
  q h s ll q at1
    l ll h . ( クロスレールと繋がる )
  bk .

load b=1-after-cross
  j at1
    save b0-out-1
  .

load b=0-after-cross
  j s h dl1
    .
  save b0-end

load b0-end
  j at
    save b1-start
    . ( b0を読むレールと繋がる )

load b1-start
  j at1
    save b1-out-0
  j ac1
      save b1=1-after-cross
    save b1=0-after-cross
  save b1-uturn

load b1-uturn
  j rr rr dr
    uturn .
  .

load b1=1-after-cross
  j fw at1
    save b1-out-1
  .

load b1=0-after-cross
  j ss dtl . . dtl . . dl1 .
  j q at
    save b1-end
  .

( *** Bからの出力部分 *** )

load b0-out-0
  l ss ll shr j ll r
  at2
    save b0-out-0-end
  h uturn1 j
  .

load b0-out-0-end
  rr bk r
  . 

load b0-out-1
  ll tr1
    .
  ss h j shr rr h r
  .

load b1-out-1
  j at2
    nip
  fw ac3
      -rot
      bk .
    s .
  h tl1
    j .
  j uturn
  j dr
    nip
  ss h dl2
    nip
  dr2
    nip
  l j rr
  .

load b1-end  
  l r h ll h r l
  q j
  dc1
      save middle-line-double-cross
    save read-a-after-cross
  .

load middle-line-double-cross
  ss ss h j .

load read-a-after-cross
  ss ss ss j l r ll
  save define-a


( ***** 入力Aの開始 ***** )

load define-a
  dr . dtl . . dtl .
    save a=1-start
  save a=0-start

load a=1-start
  ss l r at1
    save a0-out-0
  j .

load a=0-start
  j l owl2
    save a=0-after-oneway
  save a-uturn

load a-uturn
  j rr rr dr
    uturn .
  .

load a=0-after-oneway
  bk ss s
  ac
      .
    save a=1-after-cross
  save a=0-after-cross

load a=1-after-cross
  j at1
    save a0-out-1
  .

load a=0-after-cross
  j s h dl1
    .
  owl
    q h s r .
    save from-a-to-cross

load from-a-to-cross
  l s ll j .


( ***** Aの出力 ***** )
load a0-out-0
  l r owl2
    s .
  ss r tl2
    r .
  .

load a0-out-1
  l j q h .


( ***** エンコードされた S, Cからデコーダーを目指す ***** )
load s-out-to-read-a
  dts .
    ss .
  ss
  dts .
    ss .
  ss
  dts .
    ss .
  ss
  dts .
    save c-out-to-read-c

  h s
  ll
  shr shr shr shr
  ss ss h tr . ( 極性変換のため )
  save decode-s

load decode-s
  at1
    el1 .
    ll shr ss .
  fw rr ll
  ac2 . .
  dtl . . dtl . .
  dl1 . l l
  l r shr
  
load c-out-to-read-c
  h ss
  shl
  ll
  ss ss s tr .

  save decode-c

load decode-c
  at1
    el1 .
    ll shr ss .
  fw rr ll
  ac2 .
    ss .
  ss
  dts .
    s h .
  s h
  dtl . .
  dtl . .
  .

(
Copyright 2024 AKAMA Hitoshi

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the “Software”), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
)  
`      ;
    }

    var app = Elm.Main.init({
      flags: {
        program: program
      }
    });

    app.ports.save.subscribe(function (program) {
      const storage = window.localStorage;
      if (storage) {
        storage.setItem("program", program);
      }
    });
    app.ports.setPointerCaptureImpl.subscribe(function (event) {
      event.target.setPointerCapture(event.pointerId);
    });    
  </script>
</body>

</html>
